# ブラウザタイピングゲーム 仕様書

## 目的 / 概要
- ブラウザで動くシンプルなタイピングゲームを提供する。
- 出題単語はテキストファイルで管理し、差し替え可能にする。
- タイプミスを色やアクションで即時にわかるようにする。
- 単語を最後まで正しく打てたら成功演出（アニメ/効果音）を行う。
- デフォルトの制限時間は15秒（設定で変更可能）。
- ローマ字入力モード（かな/カナ→romaji）を備え、日本語リストでも快適に入力できる。

## 対象 / 対応環境
- 主要ブラウザ: Chrome / Edge / Safari / Firefox（最新2バージョン目安）
- PC前提。モバイル動作は簡易対応（保証対象外）。

## 実装方針
- 素の HTML / CSS / JavaScript（依存最小）。
- 軽量・即起動。1画面アプリ（Start / Play / Result）切替。
- 設定は `config.json` と `localStorage` を併用。URLクエリで一時上書き可。

## ゲーム仕様
- 制限時間: 15秒（既定）。設定で 10–180秒など任意に変更可能。
- 出題: 指定テキストファイルから単語を読み込み、ランダム出題（設定で順番出題可）。
- 入力判定: 逐次判定。先頭から一致した部分は「正」、次の期待文字が不一致なら「誤」を即時表示。
- 成功条件: 1単語を最後の文字まで正しく入力→成功演出（アニメ＋音）。直ちに次の単語へ。
- 終了条件: タイマー0で入力を無効化し、結果画面に遷移（スコア等表示）。

## UI / 画面構成
- スタート画面:
  - タイトル、簡易ルール、設定パネル（時間・単語リスト選択）。
  - 「Enterで開始」またはボタンで開始。
- プレイ画面:
  - 現在の単語（文字ごとに状態: 正/未入力/誤）。
  - ローマ字入力ONかつ日本語出題時は、「上段: 日本語（かな/カナ）／下段: ローマ字」の2段表示。下段は入力済みを色分け。
  - 入力欄（フォーカス固定、または全画面キーキャプチャ）。
  - タイマー（残秒バー/円）。
  - スコア（正打鍵数/成功単語数/精度%）。
  - コンボ表示（連続成功時に小バースト演出）。
- 結果画面:
  - 合計スコア、CPM/WPM、精度、成功単語数、ハイスコア。
  - ミスキー上位（押下した誤キーの上位10件）。
  - ベスト3（プレイ時間ごと）のローカルランキング（スコアと精度%）。
  - リトライ/設定へ戻るボタン。

## 視覚演出 / アクション
- 正入力: 文字を緑色に変更、軽い拡大（約100ms）。
- 誤入力: 期待文字を赤色にし、単語を軽くシェイク（60–120ms）＋短い赤フラッシュ（150ms）。
- 成功時: 単語をフェードアウトしつつ上方向に約10px浮上（150–250ms）。チェックアイコンのポップ（約120ms）。
- ゲーム終了時: 紙吹雪アニメーション＋拍手音（ミュート可）。
- タイマー: 残り5秒で色を黄→赤に変化、1秒ごとに軽いパルス。
- 配色: カラーブラインド対応（例: 緑 #2e7d32、赤 #d32f2f、未入力 #90a4ae）。

## 効果音
- 成功音: 短い「ポン」系（<200ms）。
- 誤入力音: 軽い「コツ」系（<120ms）。多発時も耳障りにならない音量。
- ミュート切替と音量調整（0–100%）。初回はミュートONで、ユーザー操作後に解除可能（自動再生制限考慮）。
- 実装はWebAudioによる合成音（外部音源ファイル不要）。

## スコアリング
- 基本スコア: 正打鍵数（Correct Keystrokes）。
- 精度: 正打鍵 / 総打鍵 × 100%（小数1桁表示）。
- CPM/WPM: CPM＝正打鍵/経過分、WPM＝(正打鍵/5)/経過分。
- コンボ: 連続成功単語数を表示（スコア加算はデフォルト無効、設定で有効化可）。

## 単語リスト仕様（テキストファイル）
- 形式: UTF-8、1行1単語。空行・前後空白は無視。
- コメント: `#` から始まる行は無視。
- 差し替え: `assets/words/` 配下の `.txt` を UI のドロップダウンで選択可能（一覧は事前定義 or マニフェスト）。
- 日本語も可。ローマ字入力ON時は、かな/カナをローマ字に自動変換して判定（簡易ヘボン準拠: しゃ→sha、っ→子音重ね、ち→chi、し→shi、つ→tsu、長音「ー」→直前母音伸長 など）。
- ん の複数表記（n/nn）などの許容は将来拡張。
- フィルタ: 最小/最大文字数、記号含有の可否を設定で制御。

## 設定項目（例; config.json / localStorage）
- `gameDurationSeconds`: 15
- `wordListPath`: `assets/words/default.txt`
- `romajiInput`: true（かな/カナ→romaji 入力）
- `randomize`: true（false でリスト順）
- `noRepeatInSession`: false
- `caseSensitive`: true/false
- `minWordLength` / `maxWordLength`: 1 / 32
- `comboBonus`: false
- `errorFlashMs` / `successAnimMs`: 150 / 200
- `sound.enabled` / `sound.volume`: true / 0.6
- URLクエリで一時上書き例: `?t=30&list=hard.txt`（t: 秒, list: パス or エイリアス）。

## ランキング（ローカル）
- 単位: プレイ時間（秒）ごとにトップ3を `localStorage` に保存。
- 表示: 結果画面に「ベスト3」として、順位・名前・スコア・精度%を表示。
- 登録: 現在の結果がトップ3に入った場合、名前入力を促し保存（未入力時は `Player`）。
- 並び順: スコア降順 → 精度降順 → 取得時刻が古い順。
 - 名前: 最大10文字（超過は切り詰め、未入力は `Player`）。

### データ保存/キー仕様
- 設定保存キー: `typing_game_settings_v1`（各設定値をJSONで保存）。
- ハイスコアキー: `typing_game_highscore_` + 秒（例: `typing_game_highscore_15`）。値は整数（正打鍵の最大値）。
- ランキングキー: `typing_game_leaderboard_` + 秒（例: `typing_game_leaderboard_15`）。
  - 値は配列（最大3件）のJSON。各要素: `{ name: string, score: number, acc: number, words: number, ts: epoch_ms }`
  - `acc` は 0〜1 の小数（表示時に百分率・小数1桁）。

## ミス集計
- プレイ中の誤入力キーをカウントし、結果画面で上位10件を表示。
- 日本語リスト + ローマ字入力ON時は、押下した英字ではなく「期待していた かな/カナ」を単位として集計・表示する。
  - 拗音は1単位（例: きゃ/キャ）。促音「っ/ッ」は重子音1文字ぶんとして1件。
  - 長音「ー」は直前母音伸長として1件。カウント表示は元の表記（ひらがな/カタカナ）で行う。

## 状態遷移
- Idle → Start（開始操作） → Playing（タイマー開始）
- Playing → Success（単語達成、演出→次単語）→ Playing
- Playing → TimeUp（0秒）→ Result
- Playing → Pause（非アクティブ/手動）→ Resume or Result
- 読み込みエラー時: フォールバックリスト使用＋警告表示。

## キーバインド
- 開始/リトライ: Enter
- ポーズ: Esc（任意）
- ミュート切替: M
- 設定へ戻る: S

## アクセシビリティ
- コントラストは WCAG AA 以上。
- 正誤表現は色依存にせず、下線/背景/アイコン併用を許容。
- OS の「簡易モーション」設定を尊重（アニメ短縮/無効）。
- スクリーンリーダー向けにライブリージョンで状況を簡潔通知（任意）。

## パフォーマンス
- 単語リストを必要に応じてプリロード。効果音は合成のため対象外。
- 文字単位の描画は CSS クラス切替でリフロー最小化。
- タイマーは `requestAnimationFrame` + `performance.now()` で精度確保。

## ファイル構成（提案）
- `index.html`: マークアップ（Start/Play/Result の3画面）
- `styles.css`: レイアウトとテーマ、アニメーション
- `main.js`: 状態管理、入力判定、レンダリング、音再生
- `config.json`: 既定の設定値
- `assets/words/default.txt`: デフォルト英単語
- `assets/words/ja_hiragana.txt`, `assets/words/ja_katakana.txt`: 日本語サンプルリスト
- （効果音はWebAudio合成のため外部ファイル不要）
- `assets/icons/`: UI アイコン（チェック等）

## エラー/例外処理
- 単語読込失敗: 組込デフォルトにフォールバック、設定UIに警告。
- 空リスト: ゲーム開始不可、ユーザーにメッセージ表示。
- 音再生不可: 自動的にミュートへ切替、トースト表示。

## 受入基準（抜粋）
- 初期起動で制限時間が15秒。設定変更で反映される。
- 単語リストをテキスト差し替えで更新でき、UIから選択できる。
- 誤タイプ時に色変化＋アクション（シェイク/フラッシュ）が発生する。
- 単語達成時に成功アニメ＋成功音（ミュート可）が再生される。
- 結果画面でスコア、精度、CPM/WPM、成功単語数、ハイスコアが表示される。
- 結果画面でミスキー上位と、プレイ時間ごとのトップ3ランキング（スコア＋精度%）が表示される。
  - 日本語リスト使用時のミスキー上位は、かな/カナ表記で表示される（例: 「っ: 3 / きゃ: 2 / シ: 1」）。
- トップ3に入った場合、名前入力ダイアログが表示され、保存後にリストへ反映される。
- ローマ字入力ON時、日本語出題では上段かな/カナ＋下段ローマ字の2段表示で入力済みが色分けされる。
- ゲーム終了時に紙吹雪＋拍手音の演出が再生される（ミュート可）。
- キーボードのみで開始→プレイ→リトライが可能。
- コントラストAA準拠、低モーション対応。

## 将来拡張（任意）
- 難易度プリセットや重み付け（頻出/レア）。
- エンドレス/ノーミス/時間加算などの別モード。
- オンラインスコア共有（今回はローカルのみ）。
- 多言語UI（i18n）。

---
この仕様で問題なければ、雛形実装（HTML/CSS/JS と `default.txt`）を作成します。設定UIや単語リスト選択UIの詳細要望があれば教えてください。
